# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

WebOffice Svelte UI is a Svelte 3 + TypeScript frontend application that provides a user-friendly interface for time registration and employee management. It connects to a private NestJS backend that communicates with WebOffice through reverse-engineered requests. The app includes an AI-powered Copilot assistant with speech recognition and synthesis for time entry.

## Commands

### Development
```bash
npm run dev            # Start dev server on port 5000 with --host flag
npm run build          # Build for production using Vite
npm run validate       # Run svelte-check for type checking
npm start              # Create config.json and start preview server on 0.0.0.0:5000
```

### Development with Production Backend (via Proxy)
The production backend is protected by Cloudflare Access. To develop locally against it:

1. Authenticate at `https://svelte-office.yonder-makers.com` in your browser
2. Get Cloudflare cookies from DevTools → Application → Cookies:
   - `CF_AppSession`
   - `CF_Authorization`
3. Add them to `.env`:
   ```
   CF_APP_SESSION=your_value_here
   CF_AUTHORIZATION=your_value_here
   ```
4. Update `public/config.json`: `{"apiUrl":"/", "webOfficeUrl": ""}`
5. Restart dev server - Vite proxy will inject CF cookies automatically

**Note**: `CF_Authorization` tokens expire (check JWT exp claim). When expired, re-authenticate and update `.env`.

## Architecture

### State Management
The application uses Svelte stores for state management with a custom persistence layer:

- **Global State**: Located in `src/state/`
  - `auth/auth.state.ts`: Manages authentication tokens, API URLs, and Toggl login status
  - `notifications/notifications.state.ts`: Global notification system
  - `persist.ts`: Automatically syncs specific stores to localStorage (AuthState, DisplayWeekends)

- **Page-Specific State**: Each major page has its own store directory (e.g., `src/pages/my-time-registration/store/`)
  - `state.ts`: Store definitions
  - `actions.ts`: State mutation actions
  - `effects.ts`: Side effects and data fetching
  - `selectors.ts`: Derived/computed values

### API Layer
All API communication is centralized in `src/apis/`:

- **Base API** (`core/base-api.ts`): Provides `doGet`, `doPost`, `doPostWithoutResponse`, and `doDelete` functions
  - Automatically includes JWT Bearer token from auth state
  - Uses `resolveApiURL()` and `resolveAuthToken()` resolvers
  - Throws API errors if response contains `errorCode`

- **API Configuration**:
  - API URL is dynamically loaded from `/dist/config.json` (generated by `npm start`)
  - During development, uses `.env` file (API_URL=http://localhost:3000/)
  - Path aliases: `@svelte-office/api` → `src/apis/index`, `@svelte-office/state` → `src/state/index`

### Routing
Uses `svelte-spa-router` with authentication guards:

- **Routes** (defined in `src/Routing.svelte`):
  - `/` and `/my-tr`: Time registration (requires auth)
  - `/employees`: Employee directory (requires auth)
  - `/holidays`: Holiday calendar (requires auth)
  - `/login`: Login page
  - `*`: 404 page

- **Auth Guard**: `authCondition()` checks if user profile exists, redirects to `/login` on failure

### Component Structure
- **Main Pages**: `src/pages/{page-name}/` - Each page is self-contained with components, store, and modals
- **Reusable Components**: `src/components/` - Shared UI components
- **Icons**: `src/components/icons/` - Custom SVG icon components

### Key Features

#### Time Registration
The main feature located in `src/pages/my-time-registration/`:
- Grid-based time entry with keyboard navigation (Ctrl+Enter to save, Escape to cancel, Arrow keys)
- Favorite tasks for quick access
- Task search functionality (case-insensitive)
- Toggl integration for importing time entries
- Work-from-home tracking

#### AI Copilot Assistant
Located in `src/pages/my-time-registration/assistant/`:
- **Service Layer** (`service-layer.ts`): Provides methods to AI for time log operations
  - `getAllTimeLogs()`: Get all time entries
  - `addOrUpdateTimeLog(taskNumber, date, hours)`: Create/update entries
  - `updateTimeLog(id, hours)`: Update specific entry
  - `deleteTimeLog(id)`: Delete entry
- **Speech Recognition** (`speech-to-text.ts`): Voice input for time entry
- **Text-to-Speech** (`text-to-synthesis.ts`): Audio responses from assistant
- Multi-language support (defined in `constants/languages.ts`)

#### Effects System
The effects system (`store/effects.ts`) is initialized in `main.ts` via `registerEffects()`:
- Subscribes to `lastRefreshDateState` to trigger data fetching
- Listens for global keyboard events (Enter, Escape, Arrow keys)
- Manages data sync between UI and backend

### Technology Stack
- **Frontend**: Svelte 3, TypeScript, Vite
- **UI Library**: Carbon Components Svelte
- **Routing**: svelte-spa-router
- **Date Handling**: date-fns
- **Utilities**: lodash
- **Search**: Fuse.js (fuzzy search)
- **Build**: Vite with legacy browser support plugin

### Build Configuration
- Vite config auto-generates path aliases from `tsconfig.json`
- Target: ES2015
- Dev/Preview server: Port 5000
- Legacy browser support enabled (not IE11)
