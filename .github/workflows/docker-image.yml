name: Docker Image CI

on:
  push:
    branches: [main]
    tags:
      - v2.*
      - v3.*
      - 2.*
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set image tag
        id: set-tag
        run: |
          # For tags, use the tag name directly (e.g., v3.0.0)
          # For branches, use the branch name with slashes replaced by dashes
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${{ github.ref_name }}"
            echo "Using tag: $TAG_NAME"
          elif [[ -n "${{ github.head_ref }}" ]]; then
            TAG_NAME=$(echo "${{ github.head_ref }}" | tr / -)
            echo "Using PR branch: $TAG_NAME"
          else
            TAG_NAME=$(echo "${{ github.ref_name }}" | tr / -)
            echo "Using branch: $TAG_NAME"
          fi
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Image tag will be: $TAG_NAME"

      - name: Login to Github docker
        run: |
          echo $CR_PAT | docker login ghcr.io -u yonder-makers --password-stdin
        env:
          CR_PAT: ${{ secrets.CR_PAT }}

      - name: Build docker image
        run: |
          docker build . --tag ghcr.io/yonder-makers/svelte-office-ui:${{ steps.set-tag.outputs.tag }}

      - name: Push image to Github container registry
        run: |
          docker push ghcr.io/yonder-makers/svelte-office-ui:${{ steps.set-tag.outputs.tag }}
